generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String     
  password    String
  name        String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  companyId   String?     @db.Uuid
  company     Company?    @relation(fields: [companyId], references: [id])
  @@unique([companyId, email])

  products    Product[]   
  movements   Movement[]  
  purchases   Purchase[]  
  sales       Sale[]      
  quotations  Quotation[]
}

model Product {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String          @db.Uuid  // ← AÑADIDO
  userId              String          @db.Uuid
  name                String
  type                String
  barcode             String?
  category            String?
  sku                 String?
  @@unique([companyId, sku])  // ← AÑADIDO
  sellAtPOS           Boolean         @default(false)
  includeInCatalog    Boolean         @default(false)
  requirePrescription Boolean         @default(false)
  saleUnit            String?
  brand               String?
  description         String?
  useStock            Boolean         @default(true)
  quantity            Float?
  price               Float?
  cost                Float?
  stock               Float?
  image               String?
  location            String?
  minimumQuantity     Float?
  satKey              String?
  iva                 Float?
  ieps                Float?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  ivaIncluded         Boolean         @default(true)
  satUnitKey          String?

  // Relaciones
  company             Company         @relation(fields: [companyId], references: [id])  // ← AÑADIDO
  movements           Movement[]
  priceLists          PriceList[]
  user                User            @relation(fields: [userId], references: [id])
  purchaseItems       PurchaseItem[]
  quotationItems      QuotationItem[]
  saleItems           SaleItem[]
  variants            Variant[]
}

model Variant {
  id        String  @id @default(cuid())
  productId String  @db.Uuid
  type      String
  value     String
  product   Product @relation(fields: [productId], references: [id])
}

model PriceList {
  id        String  @id @default(cuid())
  productId String  @db.Uuid
  name      String
  price     Float
  product   Product @relation(fields: [productId], references: [id])
}

model Movement {
  id            String   @id @default(cuid())
  productId     String   @db.Uuid
  userId        String   @db.Uuid
  date          DateTime @default(now())
  type          String
  quantity      Float
  previousStock Float
  newStock      Float
  location      String?
  note          String?
  product       Product  @relation(fields: [productId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
}

model Supplier {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId      String     @db.Uuid  // ← AÑADIDO
  name           String
  contactName    String?
  phone          String?
  email          String?
  street         String?
  neighborhood   String?
  postalCode     String?
  city           String?
  state          String?
  municipality   String?
  rfc            String?
  totalPurchases Float      @default(0)
  lastPurchase   DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relaciones
  company        Company    @relation(fields: [companyId], references: [id])  // ← AÑADIDO
  purchases      Purchase[]
}

model Purchase {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId     String         @db.Uuid  // ← AÑADIDO
  supplierId    String         @db.Uuid
  userId        String         @db.Uuid
  date          DateTime       @default(now())
  totalAmount   Float
  status        String         @default("pending")
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relaciones
  company       Company        @relation(fields: [companyId], references: [id])  // ← AÑADIDO
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  purchaseItems PurchaseItem[]
}

model PurchaseItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  purchaseId String   @db.Uuid
  productId  String   @db.Uuid
  quantity   Float
  unitPrice  Float
  totalPrice Float
  createdAt  DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id])
  purchase   Purchase @relation(fields: [purchaseId], references: [id])
}

model Customer {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId            String      @db.Uuid  // ← AÑADIDO
  name                 String
  email                String?     
  phone                String?
  address              String?
  rfc                  String?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  fiscalAddress        String?
  fiscalCity           String?
  fiscalCountry        String?     @default("México")
  fiscalExteriorNumber String?
  fiscalInteriorNumber String?
  fiscalMunicipality   String?
  fiscalNeighborhood   String?
  fiscalPostalCode     String?
  fiscalState          String?
  fiscalStreet         String?
  razonSocial          String?
  taxRegime            String?
  usoCFDI              String?

  // Relaciones
  company              Company?    @relation(fields: [companyId], references: [id])  // ← AÑADIDO
  invoices             Invoice[]
  quotations           Quotation[]
  sales                Sale[]
  
  @@unique([companyId, email])  // ← AÑADIDO
}

model Sale {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String     @db.Uuid  // ← AÑADIDO
  customerId  String     @db.Uuid
  userId      String     @db.Uuid
  date        DateTime   @default(now())
  totalAmount Float
  status      String     @default("completed")
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relaciones
  company     Company    @relation(fields: [companyId], references: [id])  // ← AÑADIDO
  invoices    Invoice[]
  customer    Customer   @relation(fields: [customerId], references: [id])
  user        User       @relation(fields: [userId], references: [id])
  saleItems   SaleItem[]
}

model SaleItem {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  saleId        String        @db.Uuid
  productId     String        @db.Uuid
  quantity      Float
  unitPrice     Float
  totalPrice    Float
  description   String?
  satProductKey String?
  satUnitKey    String?
  invoiceItems  InvoiceItem[]
  product       Product       @relation(fields: [productId], references: [id])
  sale          Sale          @relation(fields: [saleId], references: [id])
}

model Company {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  rfc            String    @unique
  regime         String
  csdCert        String?
  csdKey         String?
  csdPassword    String?
  street         String
  exteriorNumber String
  neighborhood   String
  postalCode     String
  city           String
  state          String
  municipality   String
  country        String?   @default("México")
  email          String?
  phone          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  pac            String?
  pacPass        String?
  pacUser        String?
  testMode       Boolean   @default(true)
  interiorNumber String?

  // Relaciones inversas (añadir estas)
  users          User[]
  invoices       Invoice[]
  suppliers      Supplier[]
  customers      Customer[]
  products       Product[]
  purchases      Purchase[]
  sales          Sale[]
  quotations     Quotation[]
}

model Invoice {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  saleId              String        @db.Uuid
  customerId          String        @db.Uuid
  companyId           String        @db.Uuid
  uuid                String?
  serie               String?
  folio               String?
  status              String        @default("pending")
  xmlUrl              String?
  pdfUrl              String?
  cancelledAt         DateTime?
  paymentMethod       String?
  paymentForm         String?
  currency            String?       @default("MXN")
  exchangeRate        Float?
  subtotal            Float?
  discount            Float?
  taxes               Float?
  cfdiUse             String?
  relatedInvoices     String?
  cancellationStatus  String?
  cancellationReceipt String?
  paymentAccount      String?
  verificationUrl     String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  facturamaId         String?
  stampedAt           DateTime?

  // Relaciones
  company             Company       @relation(fields: [companyId], references: [id])
  customer            Customer      @relation(fields: [customerId], references: [id])
  sale                Sale          @relation(fields: [saleId], references: [id])
  invoiceItems        InvoiceItem[]
}

model InvoiceItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId  String   @db.Uuid
  saleItemId String   @db.Uuid
  quantity   Float
  unitPrice  Float
  totalPrice Float
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  saleItem   SaleItem @relation(fields: [saleItemId], references: [id])
}

model Quotation {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId      String          @db.Uuid  // ← AÑADIDO
  customerId     String          @db.Uuid
  userId         String          @db.Uuid
  date           DateTime        @default(now())
  expiryDate     DateTime?
  totalAmount    Float
  status         String          @default("pending")
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relaciones
  company        Company         @relation(fields: [companyId], references: [id])  // ← AÑADIDO
  customer       Customer        @relation(fields: [customerId], references: [id])
  user           User            @relation(fields: [userId], references: [id])
  quotationItems QuotationItem[]
}

model QuotationItem {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quotationId   String    @db.Uuid
  productId     String    @db.Uuid
  quantity      Float
  unitPrice     Float
  totalPrice    Float
  satProductKey String?
  satUnitKey    String?
  description   String?
  createdAt     DateTime  @default(now())
  product       Product   @relation(fields: [productId], references: [id])
  quotation     Quotation @relation(fields: [quotationId], references: [id])
}